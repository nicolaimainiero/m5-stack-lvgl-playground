#include <Arduino.h>
#include <M5Unified.h>

#define LV_CONF_INCLUDE_SIMPLE
#include <lvgl.h>
#include <esp_timer.h>

constexpr int32_t HOR_RES = 320;
constexpr int32_t VER_RES = 240;

static const lv_point_t points_array[] = {
    {0, 1},  /* First button is assigned to x=0; y=1 */
    {60, 90} /* Second button is assigned to x=60; y=90 */
};

lv_display_t *display;
lv_indev_t *touchpad;
lv_indev_t *btn_A;

static int32_t temperature = 25;
static lv_obj_t *needle_line = NULL;
static lv_obj_t *scale_line = NULL;
static lv_obj_t *scale = NULL;

void display_flush(lv_display_t *disp, const lv_area_t *area, uint8_t *px_map)
{
  uint32_t w = (area->x2 - area->x1 + 1);
  uint32_t h = (area->y2 - area->y1 + 1);

  lv_draw_sw_rgb565_swap(px_map, w * h);
  M5.Display.pushImageDMA<uint16_t>(area->x1, area->y1, w, h, (uint16_t *)px_map);
  lv_disp_flush_ready(disp);
}

uint32_t tick_function()
{
  return (esp_timer_get_time() / 1000LL);
}

void touchpad_read(lv_indev_t *drv, lv_indev_data_t *data)
{
  M5.update();
  auto count = M5.Touch.getCount();

  if (count == 0)
  {
    data->state = LV_INDEV_STATE_RELEASED;
  }
  else
  {
    auto touch = M5.Touch.getDetail(0);
    data->state = LV_INDEV_STATE_PRESSED;
    data->point.x = touch.x;
    data->point.y = touch.y;
  }
}

void read_button_A(lv_indev_t *indev, lv_indev_data_t *data)
{
  M5.update();
  /* Get the ID (0,1,2...) of the pressed button.
   * Let's say it returns -1 if no button was pressed */
  int btn_pr = M5.BtnA.wasPressed();

  /* Is there a button press? */
  if (btn_pr)
  {
    data->btn_id = 1;                     /* Save the ID of the pressed button */
    data->state = LV_INDEV_STATE_PRESSED; /* Set the pressed state */
  }
  else
  {
    data->state = LV_INDEV_STATE_RELEASED; /* Set the released state */
  }
}

static void btn_event_cb(lv_event_t *e)
{
  lv_event_code_t code = lv_event_get_code(e);
  lv_obj_t *label = reinterpret_cast<lv_obj_t *>(lv_event_get_user_data(e));

  switch (code)
  {
  case LV_EVENT_PRESSED:
    lv_label_set_text(label, "The last button event:\nLV_EVENT_PRESSED");
    break;
  case LV_EVENT_CLICKED:
    lv_label_set_text(label, "The last button event:\nLV_EVENT_CLICKED");
    break;
  case LV_EVENT_LONG_PRESSED:
    lv_label_set_text(label, "The last button event:\nLV_EVENT_LONG_PRESSED");
    break;
  case LV_EVENT_LONG_PRESSED_REPEAT:
    lv_label_set_text(label, "The last button event:\nLV_EVENT_LONG_PRESSED_REPEAT");
    break;
  default:
    break;
  }
}

/**
 * Create a button with a label and react on click event.
 */
void lv_example_get_started_2(void)
{
  lv_obj_t *btn = lv_button_create(lv_screen_active()); /*Add a button the current screen*/
  lv_obj_set_size(btn, 100, 50);
  lv_obj_center(btn);

  lv_obj_t *label = lv_label_create(btn); /*Add a label to the button*/
  lv_label_set_text(label, "Button");     /*Set the labels text*/
  lv_obj_center(label);

  lv_obj_t *info_label = lv_label_create(lv_screen_active());

  lv_label_set_text(info_label, "The last button event:\nNone");

  lv_obj_add_event_cb(btn, btn_event_cb, LV_EVENT_ALL, info_label);
}

static void temperature_anim_timer_cb(lv_timer_t *timer)
{
  LV_UNUSED(timer);

  temperature++;

  if (temperature >= 40)
  {
    temperature = 10;
  }

  /* Update needle */
  lv_scale_set_line_needle_value(scale, needle_line, 60, temperature);
}

lv_obj_t *lv_example_scale_4(lv_obj_t *cont)
{

  scale = lv_scale_create(cont);
  lv_obj_set_style_margin_top(scale, 10, LV_PART_MAIN);
  lv_obj_set_size(scale, lv_pct(80), lv_pct(90));
  lv_scale_set_label_show(scale, true);
  lv_scale_set_mode(scale, LV_SCALE_MODE_ROUND_OUTER);
  lv_obj_set_align(scale, LV_ALIGN_BOTTOM_MID);

  lv_scale_set_total_tick_count(scale, 21);
  lv_scale_set_major_tick_every(scale, 5);

  lv_obj_set_style_length(scale, 5, LV_PART_ITEMS);
  lv_obj_set_style_length(scale, 10, LV_PART_INDICATOR);
  lv_scale_set_range(scale, 0, 100);

  static const char *custom_labels[] = {"0 °C", "25 °C", "50 °C", "75 °C", "100 °C", NULL};
  lv_scale_set_text_src(scale, custom_labels);

  static lv_style_t indicator_style;
  lv_style_init(&indicator_style);

  /* Label style properties */
  lv_style_set_text_font(&indicator_style, LV_FONT_DEFAULT);
  lv_style_set_text_color(&indicator_style, lv_palette_darken(LV_PALETTE_BLUE, 3));

  /* Major tick properties */
  lv_style_set_line_color(&indicator_style, lv_palette_darken(LV_PALETTE_BLUE, 3));
  lv_style_set_width(&indicator_style, 10U);     /*Tick length*/
  lv_style_set_line_width(&indicator_style, 2U); /*Tick width*/
  lv_obj_add_style(scale, &indicator_style, LV_PART_INDICATOR);

  static lv_style_t minor_ticks_style;
  lv_style_init(&minor_ticks_style);
  lv_style_set_line_color(&minor_ticks_style, lv_palette_lighten(LV_PALETTE_BLUE, 2));
  lv_style_set_width(&minor_ticks_style, 5U);      /*Tick length*/
  lv_style_set_line_width(&minor_ticks_style, 2U); /*Tick width*/
  lv_obj_add_style(scale, &minor_ticks_style, LV_PART_ITEMS);

  static lv_style_t main_line_style;
  lv_style_init(&main_line_style);
  /* Main line properties */
  lv_style_set_arc_color(&main_line_style, lv_palette_darken(LV_PALETTE_BLUE, 3));
  lv_style_set_arc_width(&main_line_style, 2U); /*Tick width*/
  lv_obj_add_style(scale, &main_line_style, LV_PART_MAIN);

  /* Add a section */
  static lv_style_t section_minor_tick_style;
  static lv_style_t section_label_style;
  static lv_style_t section_main_line_style;

  lv_style_init(&section_label_style);
  lv_style_init(&section_minor_tick_style);
  lv_style_init(&section_main_line_style);

  /* Label style properties */
  lv_style_set_text_font(&section_label_style, LV_FONT_DEFAULT);
  lv_style_set_text_color(&section_label_style, lv_palette_darken(LV_PALETTE_RED, 3));

  lv_style_set_line_color(&section_label_style, lv_palette_darken(LV_PALETTE_RED, 3));
  lv_style_set_line_width(&section_label_style, 5U); /*Tick width*/

  lv_style_set_line_color(&section_minor_tick_style, lv_palette_lighten(LV_PALETTE_RED, 2));
  lv_style_set_line_width(&section_minor_tick_style, 4U); /*Tick width*/

  /* Main line properties */
  lv_style_set_arc_color(&section_main_line_style, lv_palette_darken(LV_PALETTE_RED, 3));
  lv_style_set_arc_width(&section_main_line_style, 4U); /*Tick width*/

  /* Configure section styles */
  lv_scale_section_t *section = lv_scale_add_section(scale);
  lv_scale_set_section_range(scale, section, 75, 100);
  lv_scale_set_section_style_indicator(scale, section, &section_label_style);
  lv_scale_set_section_style_items(scale, section, &section_minor_tick_style);
  lv_scale_set_section_style_main(scale, section, &section_main_line_style);

  needle_line = lv_line_create(scale);
  lv_obj_set_style_line_color(needle_line, lv_color_black(), LV_PART_MAIN);
  lv_obj_set_style_line_width(needle_line, 3, LV_PART_MAIN);
  lv_obj_set_style_line_rounded(needle_line, true, LV_PART_MAIN);
  lv_scale_set_line_needle_value(scale, needle_line, 100, 25);

  /* animation */
  lv_timer_create(temperature_anim_timer_cb, 120, NULL);

  return scale;
}

lv_obj_t *lv_example_scale_8(lv_obj_t *cont)
{
  scale_line = lv_scale_create(cont);
  lv_obj_set_size(scale_line, 150, 150);
  lv_scale_set_mode(scale_line, LV_SCALE_MODE_ROUND_INNER);
  lv_obj_set_style_bg_opa(scale_line, LV_OPA_COVER, 0);
  lv_obj_set_style_bg_color(scale_line, lv_palette_lighten(LV_PALETTE_RED, 5), 0);
  lv_obj_set_style_radius(scale_line, LV_RADIUS_CIRCLE, 0);
  lv_obj_align(scale_line, LV_ALIGN_LEFT_MID, LV_PCT(2), 0);

  /*Set the texts' and major ticks' style (make the texts rotated)*/
  lv_obj_set_style_transform_rotation(scale_line, LV_SCALE_LABEL_ROTATE_MATCH_TICKS | LV_SCALE_LABEL_ROTATE_KEEP_UPRIGHT,
                                      LV_PART_INDICATOR);
  lv_obj_set_style_translate_x(scale_line, 10, LV_PART_INDICATOR);
  lv_obj_set_style_length(scale_line, 15, LV_PART_INDICATOR);
  lv_obj_set_style_radial_offset(scale_line, 10, LV_PART_INDICATOR);

  /*Set the style of the minor ticks*/
  lv_obj_set_style_length(scale_line, 10, LV_PART_ITEMS);
  lv_obj_set_style_radial_offset(scale_line, 5, LV_PART_ITEMS);
  lv_obj_set_style_line_opa(scale_line, LV_OPA_50, LV_PART_ITEMS);

  lv_scale_set_label_show(scale_line, true);

  lv_scale_set_total_tick_count(scale_line, 31);
  lv_scale_set_major_tick_every(scale_line, 5);

  lv_scale_set_range(scale_line, 10, 40);

  lv_scale_set_angle_range(scale_line, 270);
  lv_scale_set_rotation(scale_line, 135);

  needle_line = lv_line_create(scale_line);

  lv_obj_set_style_line_width(needle_line, 3, LV_PART_MAIN);
  lv_obj_set_style_line_rounded(needle_line, true, LV_PART_MAIN);
  lv_scale_set_line_needle_value(scale_line, needle_line, 60, 33);

  lv_timer_create(temperature_anim_timer_cb, 120, NULL);

  return scale_line;
}

lv_obj_t *button(lv_obj_t *container, u_int8_t col, u_int8_t row)
{
  lv_obj_t *label;
  lv_obj_t *obj = lv_button_create(container);

  label = lv_label_create(obj);
  lv_label_set_text_fmt(label, "c%d, r%d", col, row);
  lv_obj_center(label);
  return obj;
}

void lv_example_grid_1(void)
{

  static int32_t column_dsc[] = {LV_GRID_FR(1), LV_GRID_FR(1), LV_GRID_FR(1), LV_GRID_TEMPLATE_LAST}; /* 3 columns */
  static int32_t row_dsc[] = {LV_GRID_FR(1), LV_GRID_FR(1), LV_GRID_TEMPLATE_LAST};                   /* 2 rows */

  /*Create a container with grid*/
  lv_obj_t *cont = lv_obj_create(lv_screen_active());
  lv_obj_set_style_grid_column_dsc_array(cont, column_dsc, 0);
  lv_obj_set_style_grid_row_dsc_array(cont, row_dsc, 0);
  lv_obj_set_size(cont, HOR_RES, VER_RES);
  lv_obj_center(cont);
  lv_obj_set_layout(cont, LV_LAYOUT_GRID);

  lv_obj_t *scale = lv_example_scale_4(cont);
  // lv_obj_t *scale = lv_example_scale_8(cont);
  lv_obj_set_grid_cell(scale, LV_GRID_ALIGN_STRETCH, 0, 2,
                       LV_GRID_ALIGN_STRETCH, 0, 2);

  // lv_obj_set_grid_cell(button(cont, 1, 0), LV_GRID_ALIGN_STRETCH, 1, 1,
  //                      LV_GRID_ALIGN_STRETCH, 0, 1);
  lv_obj_set_grid_cell(button(cont, 2, 0), LV_GRID_ALIGN_STRETCH, 2, 1,
                       LV_GRID_ALIGN_STRETCH, 0, 1);

  // lv_obj_set_grid_cell(button(cont, 0, 1), LV_GRID_ALIGN_STRETCH, 0, 1,
  //                      LV_GRID_ALIGN_STRETCH, 1, 1);
  // lv_obj_set_grid_cell(button(cont, 1, 1), LV_GRID_ALIGN_STRETCH, 1, 1,
  //                      LV_GRID_ALIGN_STRETCH, 1, 1);
  lv_obj_set_grid_cell(button(cont, 2, 1), LV_GRID_ALIGN_STRETCH, 2, 1,
                       LV_GRID_ALIGN_STRETCH, 1, 1);
}

// continue setup code
void setup()
{
  M5.begin();
  lv_init();
  lv_tick_set_cb(tick_function);

  display = lv_display_create(HOR_RES, VER_RES);
  lv_display_set_flush_cb(display, display_flush);

  static lv_color_t buf1[HOR_RES * 15];
  lv_display_set_buffers(display, buf1, nullptr, sizeof(buf1), LV_DISPLAY_RENDER_MODE_PARTIAL);

  touchpad = lv_indev_create();
  lv_indev_set_type(touchpad, LV_INDEV_TYPE_POINTER);
  lv_indev_set_read_cb(touchpad, touchpad_read);

  btn_A = lv_indev_create();
  lv_indev_set_type(btn_A, LV_INDEV_TYPE_BUTTON);
  lv_indev_set_button_points(btn_A, points_array);
  lv_indev_set_read_cb(btn_A, read_button_A);

  lv_example_grid_1();
}

void loop()
{
  lv_task_handler();
  vTaskDelay(1);
}